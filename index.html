<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Crocker Rook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Teko:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --black-suit: #2d3436;
            --red-suit: #d63031;
            --green-suit: #00b894;
            --yellow-suit: #fdcb6e;
            --card-back: #2980b9;
            --table-color: #006266;
            --border-color: #feca57;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--table-color);
            color: white;
            overflow: hidden;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none;
            touch-action: manipulation;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 1200px;
            max-height: 800px;
            margin: auto;
        }

        .game-board {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            height: 70%;
            transform: translate(-50%, -50%);
            background-image: radial-gradient(circle, #007075, #005053);
            border: 8px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 30px rgba(0,0,0,0.4);
            border-radius: 100px;
        }
        
        .player-area {
            position: absolute;
            width: 50%; 
            height: 20%;
            z-index: 50;
        }

        .player-bottom { bottom: 0; left: 50%; transform: translateX(-50%); }
        .player-top { top: 0; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .player-left { top: 50%; left: 5%; width: 20%; height: 50%; transform: translateY(-50%) rotate(90deg); }
        .player-right { top: 50%; right: 5%; width: 20%; height: 50%; transform: translateY(-50%) rotate(-90deg); }
        
        .hand {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            transition: all 0.3s ease-in-out;
        }
        
        #player-0-hand, #player-2-hand {
            flex-direction: row-reverse;
        }
        
        .hand.bury-selection {
            align-content: center;
        }
        .hand.bury-selection .card {
            margin: 0 -38px; 
        }

        .card {
            position: relative;
            width: 70px;
            height: 100px;
            background-color: white;
            border: 1px solid #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-family: 'Teko', sans-serif;
            font-size: 28px;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 3px 3px 7px rgba(0,0,0,0.3);
            margin: 0 -25px;
            transform-style: preserve-3d;
        }
        
        .card .card-face, .card .card-back-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.6s;
        }
        
        .card .card-back-face {
            background-color: var(--card-back);
            transform: rotateY(180deg);
            font-size: 40px;
        }

        .card.is-flipped .card-face { transform: rotateY(-180deg); }
        .card.is-flipped .card-back-face { transform: rotateY(0deg); }
        
        .player-bottom .card:hover {
            transform: translateY(-20px) scale(1.1);
            z-index: 100;
        }

        .card.playable { box-shadow: 0 0 15px 5px #ffdd59; z-index: 100; }
        .card.selected-for-bury { transform: translateY(-20px) scale(1.05); box-shadow: 0 0 15px 5px #3498db; z-index: 101; }
        .card.selected-to-play {
            transform: translateY(-20px) scale(1.15) !important;
            box-shadow: 0 0 20px 8px #2ecc71 !important;
            z-index: 102 !important;
        }
        
        .card .rank { position: absolute; top: 5px; left: 8px; font-size: 20px; }
        .card .suit-icon { font-size: 40px; }
        .card[data-suit="Black"] { color: var(--black-suit); }
        .card[data-suit="Red"] { color: var(--red-suit); }
        .card[data-suit="Green"] { color: var(--green-suit); }
        .card[data-suit="Yellow"] { color: var(--yellow-suit); }
        .card[data-suit="Special"] { color: var(--black-suit); }

        .trick-area, .nest-display-area {
            position: absolute;
            top: 50%; left: 50%;
            width: 50%; height: 50%;
            transform: translate(-50%, -50%);
        }
        .nest-display-area .card { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); cursor: default; }
        .trick-area .card { position: absolute; cursor: default; }
        
        .player-info { position: absolute; background-color: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 8px; font-size: 14px; text-align: center; }
        .info-top { top: 21%; left: 50%; transform: translateX(-50%); }
        .info-bottom { bottom: 21%; left: 50%; transform: translateX(-50%); }
        .info-left { left: 16%; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .info-right { right: 16%; top: 50%; transform: translateY(-50%) rotate(-90deg); }
        .player-info.high-bidder {
            border: 3px solid var(--yellow-suit);
            box-shadow: 0 0 20px 5px var(--yellow-suit);
        }

        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; z-index: 200; pointer-events: none; }
        .modal.active { pointer-events: auto; background-color: rgba(0,0,0,0.6); }
        
        #bury-modal.active {
            background-color: transparent;
            pointer-events: none;
        }
        
        #bidding-modal, #difficulty-modal, #trump-modal, #round-summary-modal, #last-trick-modal, #settings-modal, #rules-modal, #strategy-modal { 
            align-items: center; 
        }
        
        #bury-modal {
            align-items: flex-end;
            padding-bottom: 22%;
        }
        
        .modal-content { background-color: #333; padding: 30px; border-radius: 15px; text-align: center; border: 4px solid var(--border-color); box-shadow: 0 0 25px rgba(0,0,0,0.7); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .modal.active .modal-content { opacity: 1; pointer-events: auto; }
        
        #bury-modal .modal-content {
            max-width: 400px;
            padding: 15px;
        }
        #bid-input, #winning-score-input { color: white; background-color: #555; text-align: center; }

        .modal-content button, .new-game-btn, .utility-btn { background-color: var(--yellow-suit); color: var(--black-suit); border: none; padding: 10px 20px; margin: 5px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px #b88a1b; }
        .modal-content button:hover, .new-game-btn:hover, .utility-btn:hover { background-color: #ffde7a; transform: translateY(-2px); box-shadow: 0 6px #b88a1b; }
        .modal-content button:active, .new-game-btn:active, .utility-btn:active { transform: translateY(2px); box-shadow: 0 2px #b88a1b; }
        .modal-content button:disabled, .utility-btn:disabled { background-color: #999; cursor: not-allowed; box-shadow: 0 4px #666; }
        
        .hamburger-menu { position: absolute; top: 20px; right: 20px; z-index: 220; }
        .hamburger-icon { width: 40px; height: 40px; display: flex; flex-direction: column; justify-content: space-around; cursor: pointer; background-color: var(--yellow-suit); padding: 8px; border-radius: 8px; }
        .hamburger-icon .bar { width: 100%; height: 3px; background-color: var(--black-suit); border-radius: 2px; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 50px; background-color: #333; border: 2px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { display: block; width: 100%; padding: 12px 20px; color: white; text-align: left; background: none; border: none; cursor: pointer; }
        .dropdown-item:hover { background-color: #444; }

        .trump-indicator { position: absolute; top: 80px; right: 20px; width: 50px; height: 50px; border-radius: 50%; border: 4px solid white; display: flex; justify-content: center; align-items: center; font-size: 30px; font-weight: bold; background-color: #333; z-index: 210; }
        
        .status-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.8); padding: 20px 40px; border-radius: 15px; font-size: 24px; font-weight: bold; border: 3px solid var(--border-color); z-index: 250; }
        
        #widow-on-table { position: absolute; }
        #widow-on-table .card { position: absolute; }

        #see-last-trick-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 210;
        }

        .game-summary-box {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 210;
            background-color: rgba(0,0,0,0.5);
            padding: 8px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            font-size: 11px;
            width: 180px;
        }
        .game-summary-box .total-scores {
            display: flex;
            justify-content: space-between;
        }
        .last-trick-display { display: flex; justify-content: center; gap: 10px; padding: 20px; }

        .score-pad {
            background-color: #e9e4d4;
            color: #3d3d3d;
            border-radius: 8px;
            padding: 15px;
            width: 350px;
            font-family: 'Courier New', Courier, monospace;
            border: 1px solid #c8bca8;
        }
        .score-pad-header, .score-pad-row, .score-pad-footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            text-align: center;
            padding: 8px 0;
        }
        .score-pad-header {
            font-weight: bold;
            font-size: 1.1rem;
            border-bottom: 2px solid #a4b0be;
        }
        .score-pad-body {
            max-height: 200px;
            overflow-y: auto;
        }
        .score-pad-row {
            border-bottom: 1px dashed #a4b0be;
        }
        .score-pad-footer {
            font-weight: bold;
            font-size: 1.1rem;
            border-top: 2px solid #a4b0be;
            margin-top: 5px;
            padding-top: 10px;
        }

    </style>
</head>
<body>
    <div class="game-container">
        <div id="game-summary-box" class="game-summary-box hidden"></div>
        <button id="see-last-trick-btn" class="utility-btn" disabled>See Last Trick</button>
        
        <div id="trump-indicator" class="trump-indicator hidden"></div>
        
        <div id="hamburger-menu" class="hamburger-menu">
            <div id="hamburger-icon" class="hamburger-icon">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <div id="dropdown-menu" class="dropdown-menu">
                <button id="menu-new-game" class="dropdown-item">New Game</button>
                <button id="menu-settings" class="dropdown-item">Settings</button>
                <button id="menu-exit" class="dropdown-item">Exit</button>
            </div>
        </div>
        
        <div class="player-area player-top"><div id="player-2-hand" class="hand"></div></div>
        <div class="player-area player-left"><div id="player-1-hand" class="hand"></div></div>
        <div class="player-area player-right"><div id="player-3-hand" class="hand"></div></div>
        <div class="player-area player-bottom"><div id="player-0-hand" class="hand"></div></div>

        <div id="player-0-info" class="player-info info-bottom"></div>
        <div id="player-1-info" class="player-info info-left"></div>
        <div id="player-2-info" class="player-info info-top"></div>
        <div id="player-3-info" class="player-info info-right"></div>

        <div class="game-board">
            <div id="nest-display-area" class="nest-display-area"></div>
            <div id="trick-area" class="trick-area"></div>
            <div id="widow-on-table"></div>
        </div>

        <div id="status-message" class="status-message hidden"></div>

        <!-- Modals -->
        <div id="difficulty-modal" class="modal active"></div>
        <div id="bidding-modal" class="modal"></div>
        <div id="trump-modal" class="modal"></div>
        <div id="bury-modal" class="modal"></div>
        <div id="round-summary-modal" class="modal"></div>
        <div id="last-trick-modal" class="modal"></div>
        <div id="settings-modal" class="modal"></div>
        <div id="rules-modal" class="modal"></div>
        <div id="strategy-modal" class="modal"></div>
    </div>

    <script>
        const SUITS = ['Black', 'Red', 'Green', 'Yellow'];
        const RANKS = [5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 1];
        let WINNING_SCORE = 500;
        const HUMAN_PLAYER_ID = 0;

        class Card {
            constructor(suit, rank) { this.suit = suit; this.rank = rank; this.id = `${suit}-${rank}`; }
            get value() { if (this.rank === 'Rook') return 20; const r = Number(this.rank); if (r === 1) return 15; if (r === 10 || r === 14) return 10; if (r === 5) return 5; return 0; }
            get power() { if (this.rank === 'Rook') return 20; const r = Number(this.rank); if (r === 1) return 15; return r; }
        }

        class Deck {
            constructor() { this.cards = []; this.create(); }
            create() { this.cards = []; for (const suit of SUITS) { for (const rank of RANKS) { this.cards.push(new Card(suit, rank)); } } this.cards.push(new Card('Special', 'Rook')); }
            shuffle() { for (let i = this.cards.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]]; } }
            deal(numPlayers, cardsPerPlayer) {
                const hands = Array.from({ length: numPlayers }, () => []);
                const nest = [];
                for (let i = 0; i < 5; i++) { nest.push(this.cards.pop()); }
                for (let i = 0; i < cardsPerPlayer; i++) { for (let j = 0; j < numPlayers; j++) { hands[j].push(this.cards.pop()); } }
                return { hands, nest };
            }
        }

        class Player {
            constructor(id, isHuman = false) { this.id = id; this.hand = []; this.isHuman = isHuman; this.partnerId = (id + 2) % 4; this.hasPassed = false; }
            sortHand(trumpSuit = null, sortOrder = 'asc') {
                this.hand.sort((a, b) => {
                    const isARook = a.rank === 'Rook';
                    const isBRook = b.rank === 'Rook';

                    if (isARook) return sortOrder === 'asc' ? 1 : -1;
                    if (isBRook) return sortOrder === 'asc' ? -1 : 1;

                    const isATrump = a.suit === trumpSuit;
                    const isBTrump = b.suit === trumpSuit;

                    if (isATrump !== isBTrump) {
                        return (sortOrder === 'asc' ? 1 : -1) * (isATrump ? 1 : -1);
                    }
                    
                    if (a.suit !== b.suit) {
                        return SUITS.indexOf(a.suit) - SUITS.indexOf(b.suit);
                    }

                    return (sortOrder === 'asc' ? 1 : -1) * (a.power - b.power);
                });
            }

            getAdvancedBid(currentBid, hasShootTheMoonOption) {
                let handValue = 0;
                // Basic point card values
                handValue += this.hand.filter(c => c.rank === 'Rook').length * 25;
                handValue += this.hand.filter(c => c.rank === 1).length * 15;
                handValue += this.hand.filter(c => c.rank === 14).length * 10;
                handValue += this.hand.filter(c => c.rank === 10).length * 8;
                handValue += this.hand.filter(c => c.rank === 5).length * 5;

                const suitCounts = SUITS.reduce((acc, suit) => { acc[suit] = this.hand.filter(c => c.suit === suit).length; return acc; }, {});
                
                // Advanced distribution valuation
                for (const suit in suitCounts) {
                    if (suitCounts[suit] >= 5) handValue += suitCounts[suit] * 5; // Long suit bonus
                    if (suitCounts[suit] === 0) handValue += 18; // Void bonus
                    if (suitCounts[suit] === 1) handValue += 8;  // Singleton bonus
                }

                if (handValue > 150 && hasShootTheMoonOption) return 'shoot';
                
                // Convert hand value to a reasonable bid
                const potentialBid = 75 + Math.floor(handValue / 5) * 5;

                if (potentialBid > currentBid && potentialBid < 181) {
                    return Math.min(potentialBid, currentBid + 15); // Don't jump too high
                }
                return 'pass';
            }

            chooseAdvancedTrumpAndBury() {
                let bestSuit = '';
                let maxSuitScore = -1;

                // 1. Determine the best trump suit from the 15 cards
                for (const suit of SUITS) {
                    let currentSuitScore = 0;
                    const trumps = this.hand.filter(c => c.suit === suit);
                    const controlCards = trumps.filter(c => c.power >= 13); // 13, 14, 1
                    
                    currentSuitScore += trumps.length * 10; // Base value for length
                    currentSuitScore += controlCards.length * 15; // Value for high trumps
                    if (this.hand.some(c => c.rank === 'Rook')) {
                        currentSuitScore += 20; // Rook is always good
                    }

                    if (currentSuitScore > maxSuitScore) {
                        maxSuitScore = currentSuitScore;
                        bestSuit = suit;
                    }
                }
                game.trumpSuit = bestSuit; // Temporarily set for sorting

                // 2. Identify cards to bury
                const cardsToKeep = [];
                const cardsToConsiderBurying = [];

                // Always keep the Rook and all trumps
                this.hand.forEach(card => {
                    if (card.rank === 'Rook' || card.suit === bestSuit) {
                        cardsToKeep.push(card);
                    } else {
                        cardsToConsiderBurying.push(card);
                    }
                });

                // Keep off-suit Aces (1s)
                const offSuitAces = cardsToConsiderBurying.filter(c => c.rank === 1);
                cardsToKeep.push(...offSuitAces);
                
                // The rest are candidates for burying
                let buryCandidates = cardsToConsiderBurying.filter(c => c.rank !== 1);

                // Prioritize burying to create voids/singletons
                buryCandidates.sort((a, b) => {
                    const suitCountA = this.hand.filter(c => c.suit === a.suit).length;
                    const suitCountB = this.hand.filter(c => c.suit === b.suit).length;
                    if (suitCountA !== suitCountB) {
                        return suitCountA - suitCountB; // Bury from shorter suits first
                    }
                    return a.value - b.value; // Then bury lower value cards
                });

                const toBury = buryCandidates.slice(0, 5);
                
                // Final hand is what's left
                this.hand = this.hand.filter(c => !toBury.includes(c));

                return { trumpSuit: bestSuit, buriedCards: toBury };
            }

            playAdvancedCard(trick, trumpSuit, trickHistory) {
                const playableCards = this.getPlayableCards(trick.map(p => p.card), trumpSuit);
                const trickCards = trick.map(p => p.card);

                // If leading the trick
                if (trick.length === 0) {
                    // Strategy: Pull trump if strong, otherwise lead a singleton to create a void
                    const trumpsInHand = this.hand.filter(c => c.suit === trumpSuit || c.rank === 'Rook');
                    if (trumpsInHand.length > this.hand.length / 2 && trumpsInHand.some(c => c.power > 13)) {
                        return trumpsInHand.sort((a,b) => b.power - a.power)[0]; // Lead highest trump
                    }
                    
                    const suitCounts = SUITS.reduce((acc, s) => ({...acc, [s]: this.hand.filter(c => c.suit === s).length}), {});
                    const singletonSuit = Object.keys(suitCounts).find(s => suitCounts[s] === 1 && s !== trumpSuit);
                    if (singletonSuit) {
                        return this.hand.find(c => c.suit === singletonSuit); // Lead singleton
                    }
                    
                    // Default: lead lowest non-trump
                    return playableCards.filter(c => c.suit !== trumpSuit).sort((a,b) => a.power - b.power)[0] || playableCards[0];
                }

                // If following suit
                const winnerInfo = game.determineTrickWinner(trick);
                const partnerIsWinning = winnerInfo && winnerInfo.player.id === this.partnerId;

                if (partnerIsWinning) {
                    // "Smear" points if partner is winning
                    const pointCards = playableCards.filter(c => c.value > 0).sort((a, b) => b.value - a.value);
                    if (pointCards.length > 0) {
                        return pointCards[0]; // Play highest point card
                    }
                    // Otherwise, slough off lowest card
                    return playableCards.sort((a, b) => a.power - b.power)[0];
                } else {
                    // Try to win the trick
                    const leadSuit = trickCards[0].rank === 'Rook' ? trumpSuit : trickCards[0].suit;
                    const winningCard = winnerInfo.card;

                    const canWinCards = playableCards.filter(c => {
                        if (c.rank === 'Rook') return true;
                        if (winningCard.rank === 'Rook') return false;
                        if (c.suit === trumpSuit && winningCard.suit !== trumpSuit) return true;
                        if (c.suit === trumpSuit && winningCard.suit === trumpSuit) return c.power > winningCard.power;
                        if (c.suit === leadSuit && winningCard.suit !== trumpSuit) return c.power > winningCard.power;
                        return false;
                    });

                    if (canWinCards.length > 0) {
                        // Win with the lowest possible card
                        return canWinCards.sort((a, b) => a.power - b.power)[0];
                    }
                    // Can't win, play lowest card
                    return playableCards.sort((a, b) => a.power - b.power)[0];
                }
            }

            getPlayableCards(trickCards, trumpSuit) {
                if (!trickCards || trickCards.length === 0) {
                    return [...this.hand];
                }

                const leadCard = trickCards[0];
                let leadSuit = leadCard.rank === 'Rook' ? trumpSuit : leadCard.suit;

                const cardsInLeadSuit = this.hand.filter(c => {
                    if (leadSuit === trumpSuit) {
                        return c.suit === trumpSuit || c.rank === 'Rook';
                    }
                    return c.suit === leadSuit;
                });

                if (cardsInLeadSuit.length > 0) {
                    return cardsInLeadSuit;
                }
                return [...this.hand];
            }
        }

        class Game {
            constructor() {
                this.dom = {
                    hands: Array.from({length: 4}, (_, i) => document.getElementById(`player-${i}-hand`)),
                    infos: Array.from({length: 4}, (_, i) => document.getElementById(`player-${i}-info`)),
                    trickArea: document.getElementById('trick-area'),
                    nestDisplay: document.getElementById('nest-display-area'),
                    widowOnTable: document.getElementById('widow-on-table'),
                    gameSummaryBox: document.getElementById('game-summary-box'),
                    difficultyModal: document.getElementById('difficulty-modal'),
                    biddingModal: document.getElementById('bidding-modal'),
                    buryModal: document.getElementById('bury-modal'),
                    trumpModal: document.getElementById('trump-modal'),
                    lastTrickModal: document.getElementById('last-trick-modal'),
                    settingsModal: document.getElementById('settings-modal'),
                    rulesModal: document.getElementById('rules-modal'),
                    strategyModal: document.getElementById('strategy-modal'),
                    statusMessage: document.getElementById('status-message'),
                    seeLastTrickBtn: document.getElementById('see-last-trick-btn'),
                    trumpIndicator: document.getElementById('trump-indicator'),
                    roundSummaryModal: document.getElementById('round-summary-modal'),
                    hamburgerIcon: document.getElementById('hamburger-icon'),
                    dropdownMenu: document.getElementById('dropdown-menu'),
                    menuNewGame: document.getElementById('menu-new-game'),
                    menuSettings: document.getElementById('menu-settings'),
                    menuExit: document.getElementById('menu-exit'),
                };
                this.players = [new Player(0, true), new Player(1), new Player(2), new Player(3)];
                this.scores = { team1: 0, team2: 0 };
                this.dealerIndex = 3;
                this.handHistory = [];
                this.lastTrick = [];
                this.trickHistory = [];
                this.handSortOrder = 'asc';
                this.initModals();
                this.initMenu();
                this.dom.seeLastTrickBtn.addEventListener('click', () => this.showLastTrick());
            }

            initMenu() {
                this.dom.hamburgerIcon.addEventListener('click', () => {
                    this.dom.dropdownMenu.classList.toggle('show');
                });
                this.dom.menuNewGame.addEventListener('click', () => {
                    this.dom.dropdownMenu.classList.remove('show');
                    this.showModal('difficulty');
                });
                this.dom.menuSettings.addEventListener('click', () => {
                    this.dom.dropdownMenu.classList.remove('show');
                    this.showModal('settings');
                });
                this.dom.menuExit.addEventListener('click', () => {
                    this.dom.dropdownMenu.classList.remove('show');
                    this.showModal('difficulty');
                });
                document.addEventListener('click', (e) => {
                    if (!this.dom.hamburgerIcon.contains(e.target) && !this.dom.dropdownMenu.contains(e.target)) {
                        this.dom.dropdownMenu.classList.remove('show');
                    }
                });
            }

            initModals() {
                this.dom.difficultyModal.innerHTML = this.createModalContent('Select Difficulty', `
                    <div class="flex flex-col gap-4">
                        <div class="flex gap-4 justify-center">
                            <button data-difficulty="easy">Easy</button>
                            <button data-difficulty="medium">Medium</button>
                            <button data-difficulty="hard">Hard</button>
                        </div>
                        <div class="flex gap-4 justify-center">
                            <button id="view-rules-btn" class="utility-btn bg-blue-500 hover:bg-blue-600 mt-4">View Rules</button>
                            <button id="view-strategy-btn" class="utility-btn bg-green-500 hover:bg-green-600 mt-4">Learn</button>
                        </div>
                    </div>`);
                this.dom.biddingModal.innerHTML = this.createModalContent('Your Bid', `
                    <p class="mb-2">Current Bid: <span id="current-bid-display"></span></p>
                    <div id="bid-options" class="flex items-center justify-center">
                        <input type="number" id="bid-input" class="p-2 rounded" min="90" max="180" step="5">
                        <button id="submit-bid-button">Bid</button>
                    </div>
                    <div class="mt-4">
                        <button id="pass-button">Pass</button>
                        <button id="shoot-moon-button" class="bg-red-600 hover:bg-red-700">Shoot the Moon!</button>
                    </div>`);
                this.dom.trumpModal.innerHTML = this.createModalContent('Name the Trump Suit', `
                    <div id="trump-options" class="flex gap-4">
                        <button data-suit="Black" class="w-16 h-16 rounded-full text-4xl" style="background-color: var(--black-suit); color: white;">B</button>
                        <button data-suit="Red" class="w-16 h-16 rounded-full text-4xl" style="background-color: var(--red-suit); color: white;">R</button>
                        <button data-suit="Green" class="w-16 h-16 rounded-full text-4xl" style="background-color: var(--green-suit); color: white;">G</button>
                        <button data-suit="Yellow" class="w-16 h-16 rounded-full text-4xl" style="background-color: var(--yellow-suit); color: black;">Y</button>
                    </div>`);
                this.dom.buryModal.innerHTML = this.createModalContent('Create the Widow', `
                         <p>Select 5 cards from your hand to place in the Widow.</p>
                         <p>Selected: <span id="bury-count">0</span> / 5</p>
                         <button id="bury-confirm-button" class="mt-4" disabled>Confirm</button>`);
                this.dom.roundSummaryModal.innerHTML = this.createModalContent('Score Pad', `
                    <div id="score-pad" class="score-pad">
                        <div class="score-pad-header">
                            <div>Team 1 (You & P3)</div>
                            <div>Team 2 (P2 & P4)</div>
                        </div>
                        <div id="score-pad-body" class="score-pad-body"></div>
                        <div class="score-pad-footer">
                            <div id="total-score-1">Total: 0</div>
                            <div id="total-score-2">Total: 0</div>
                        </div>
                    </div>
                    <button id="continue-button" class="mt-6">Continue</button>`);
                this.dom.lastTrickModal.innerHTML = this.createModalContent('Last Trick', `<div id="last-trick-display" class="last-trick-display"></div><button id="close-last-trick" class="mt-4">Close</button>`);
                this.dom.settingsModal.innerHTML = this.createModalContent('Settings', `
                    <div class="flex flex-col gap-6 items-center">
                        <div>
                            <label for="winning-score-input" class="block mb-2">Winning Score:</label>
                            <input type="number" id="winning-score-input" class="p-2 rounded w-24" value="${WINNING_SCORE}" step="50">
                        </div>
                        <div>
                            <p class="block mb-2">Organize Hand By:</p>
                            <div class="flex gap-4">
                                <label><input type="radio" name="sortOrder" value="desc" ${this.handSortOrder === 'desc' ? 'checked' : ''}> Descending</label>
                                <label><input type="radio" name="sortOrder" value="asc" ${this.handSortOrder === 'asc' ? 'checked' : ''}> Ascending</label>
                            </div>
                        </div>
                        <button id="save-settings-btn">Save</button>
                    </div>`);
                
                const rulesContent = `
                    <div class="text-left max-h-96 overflow-y-auto pr-4">
                        <h3 class="text-xl font-bold mb-2">Object of the Game</h3>
                        <p>To be the first team to reach a predetermined number of points (default 500). Points are scored by capturing cards with point values in tricks.</p>
                        
                        <h3 class="text-xl font-bold mt-4 mb-2">The Cards & Values</h3>
                        <ul>
                            <li>- The Rook Bird card is the highest trump.</li>
                            <li>- 1s are worth 15 points.</li>
                            <li>- 14s (high) & 10s are worth 10 points.</li>
                            <li>- 5s are worth 5 points.</li>
                            <li>- Other cards have no point value.</li>
                        </ul>

                        <h3 class="text-xl font-bold mt-4 mb-2">The Deal</h3>
                        <p>Each player receives 10 cards. A 5-card "nest" is placed on the table.</p>

                        <h3 class="text-xl font-bold mt-4 mb-2">Bidding</h3>
                        <p>Players bid for the privilege of naming the trump suit. The minimum bid is 90. The player who wins the bid takes the 5 cards from the nest, then discards 5 cards. These discarded cards are called the "widow".</p>

                        <h3 class="text-xl font-bold mt-4 mb-2">Playing the Hand</h3>
                        <p>The high bidder leads the first trick. You must follow the suit led if you can. If you cannot follow suit, you may play any card, including a trump card. The highest card of the suit led wins the trick, unless a trump is played, in which case the highest trump card wins.</p>

                        <h3 class="text-xl font-bold mt-4 mb-2">Scoring</h3>
                        <p>At the end of the hand, each team counts the points from the cards they've captured (including the widow for the winning team). If the bidding team meets their bid, they score all the points they took. If they fail, they are "set" and their bid amount is subtracted from their score. The non-bidding team always scores the points they took.</p>
                    </div>
                    <button id="close-rules-btn" class="mt-4">Close</button>
                `;
                this.dom.rulesModal.innerHTML = this.createModalContent('Game Rules', rulesContent);
                const strategyContent = `
                    <div class="text-left max-h-96 overflow-y-auto pr-4">
                        <h3 class="text-xl font-bold mb-2">Bidding Strategy</h3>
                        <p>A good bid is based on the number of trump cards you have, high point cards (1s, 14s, 10s), and the Rook. A common rule of thumb is to count 20-25 points for the Rook, 15 for each Ace (1), and 5-10 for each trump card over 3. If you have a void (no cards of a suit), you can bid higher.</p>
                        
                        <h3 class="text-xl font-bold mt-4 mb-2">Creating the Widow</h3>
                        <p>After winning the bid, your goal is to create the strongest hand possible. Generally, you want to discard non-trump, low-value cards. Getting rid of an entire suit (creating a void) is a powerful strategy, as it allows you to trump when that suit is led.</p>

                        <h3 class="text-xl font-bold mt-4 mb-2">Playing Strategy</h3>
                        <p>If you have the lead and a strong trump suit, it's often wise to lead with high trumps to "pull out" your opponents' trumps. If your partner has won the trick, try to discard a high-point card of a different suit to give them extra points. Pay attention to what's been played!</p>
                    </div>
                    <button id="close-strategy-btn" class="mt-4">Close</button>
                `;
                this.dom.strategyModal.innerHTML = this.createModalContent('Game Strategy', strategyContent);

                this.dom.difficultyModal.addEventListener('click', e => {
                    if (e.target.dataset.difficulty) {
                        this.difficulty = e.target.dataset.difficulty;
                        this.hideModal('difficulty');
                        this.startNewGame();
                    } else if (e.target.id === 'view-rules-btn') {
                        this.showModal('rules');
                    } else if (e.target.id === 'view-strategy-btn') {
                        this.showModal('strategy');
                    }
                });
                this.dom.rulesModal.addEventListener('click', e => {
                    if (e.target.id === 'close-rules-btn') {
                        this.hideModal('rules');
                    }
                });
                this.dom.strategyModal.addEventListener('click', e => {
                    if (e.target.id === 'close-strategy-btn') {
                        this.hideModal('strategy');
                    }
                });
                this.dom.roundSummaryModal.addEventListener('click', e => {
                    if (e.target.id === 'continue-button') {
                        this.hideModal('roundSummary');
                        if (this.scores.team1 >= WINNING_SCORE || this.scores.team2 >= WINNING_SCORE) {
                            this.showMessage(`${this.scores.team1 >= WINNING_SCORE ? "Team 1" : "Team 2"} wins the game!`, 5000);
                        } else {
                            this.startNewHand();
                        }
                    }
                });
                this.dom.lastTrickModal.addEventListener('click', e => {
                    if (e.target.id === 'close-last-trick') {
                        this.hideModal('lastTrick');
                    }
                });
                this.dom.settingsModal.addEventListener('click', e => {
                    if (e.target.id === 'save-settings-btn') {
                        const newScore = document.getElementById('winning-score-input').value;
                        WINNING_SCORE = parseInt(newScore, 10) || 500;
                        
                        const newSortOrder = document.querySelector('input[name="sortOrder"]:checked').value;
                        this.handSortOrder = newSortOrder;
                        this.players.forEach(p => p.sortHand(this.trumpSuit, this.handSortOrder));
                        this.renderAllHands();

                        this.showMessage(`Settings saved!`, 2000);
                        this.hideModal('settings');
                    }
                });
            }

            createModalContent(title, body) {
                return `<div class="modal-content"><h2 class="text-2xl font-bold mb-4">${title}</h2>${body}</div>`;
            }

            showModal(modalName) { this.dom[modalName + 'Modal'].classList.add('active'); }
            hideModal(modalName) { this.dom[modalName + 'Modal'].classList.remove('active'); }

            startNewGame() {
                this.scores = { team1: 0, team2: 0 };
                this.dealerIndex = 3;
                this.handHistory = [];
                this.updateScoreboard();
                this.startNewHand();
            }

            startNewHand() {
                this.currentHandData = { rookWinner: null };
                this.lastTrick = [];
                this.trickHistory = [];
                this.dom.seeLastTrickBtn.disabled = true;
                this.updateLiveSummary();
                this.dom.gameSummaryBox.classList.remove('hidden');
                this.dom.trickArea.innerHTML = '';
                this.dom.nestDisplay.innerHTML = '';
                this.dom.widowOnTable.innerHTML = '';
                this.dom.trumpIndicator.classList.add('hidden');
                this.dealerIndex = (this.dealerIndex + 1) % 4;
                this.currentHandData.dealer = this.dealerIndex;
                this.updateLiveSummary('dealer');
                this.deck = new Deck(); this.deck.shuffle();
                const { hands, nest } = this.deck.deal(4, 10);
                this.nest = nest;
                this.widow = [];
                this.dom.infos.forEach((info, i) => {
                    info.classList.remove('font-bold', 'text-yellow-300', 'high-bidder');
                    info.textContent = i === this.dealerIndex ? `Player ${i + 1} (D)` : i === 0 ? `You` : i === 2 ? `Partner` : `Player ${i + 1}`;
                });
                this.players.forEach((player, i) => { player.hand = hands[i]; player.sortHand(null, this.handSortOrder); });
                this.renderNest();
                this.renderAllHands(true);
                setTimeout(() => { this.renderAllHands(false); this.startBidding(); }, 2000);
            }
            
            async startBidding() {
                this.highBid = 85; this.highBidder = null;
                this.players.forEach(p => p.hasPassed = false);
                this.bidTurnIndex = (this.dealerIndex + 1) % 4;
                this.biddingRound = 0;
                while (this.players.filter(p => !p.hasPassed).length > 1) {
                    const player = this.players[this.bidTurnIndex];
                    if (player.hasPassed) { this.bidTurnIndex = (this.bidTurnIndex + 1) % 4; continue; }
                    this.dom.infos.forEach(info => info.classList.remove('font-bold', 'text-yellow-300'));
                    this.dom.infos[this.bidTurnIndex].classList.add('font-bold', 'text-yellow-300');
                    const hasShootOpt = this.biddingRound < 4;
                    let bid;
                    if (player.isHuman) { 
                        bid = await this.getHumanBid(hasShootOpt); 
                    } else { 
                        await this.sleep(1500); 
                        if (this.difficulty === 'hard') {
                            bid = player.getAdvancedBid(this.highBid, hasShootOpt);
                        } else {
                            bid = player.getBid(this.highBid, hasShootOpt, this.difficulty);
                        }
                        this.showMessage(`${this.dom.infos[player.id].textContent} bids ${bid}`, 1400); 
                    }
                    
                    this.dom.infos.forEach(info => info.classList.remove('high-bidder'));
                    if (bid === 'shoot') { this.highBid = 'shoot'; this.highBidder = player; this.dom.infos[this.players.indexOf(this.highBidder)].classList.add('high-bidder'); break; }
                    else if (bid === 'pass') { player.hasPassed = true; }
                    else { this.highBid = bid; this.highBidder = player; this.dom.infos[this.players.indexOf(this.highBidder)].classList.add('high-bidder');}
                    this.bidTurnIndex = (this.bidTurnIndex + 1) % 4; this.biddingRound++;
                }
                if (!this.highBidder) { this.highBidder = this.players.find(p => !p.hasPassed) || this.players[this.dealerIndex]; this.highBid = this.highBidder ? this.highBid : 90; if(!this.highBidder) this.highBidder = this.players[this.dealerIndex]; this.dom.infos[this.players.indexOf(this.highBidder)].classList.add('high-bidder'); }
                
                this.currentHandData.highBidder = this.dom.infos[this.highBidder.id].textContent;
                this.currentHandData.bidAmount = this.highBid;
                this.updateLiveSummary('bid');

                if (this.highBid === 'shoot') { this.showMessage(`${this.currentHandData.highBidder} is Shooting the Moon!`, 2000); this.highBid = 180; this.isShootingMoon = true; }
                else { this.showMessage(`${this.currentHandData.highBidder} won with ${this.highBid}`, 2000); this.isShootingMoon = false; }
                await this.sleep(2000); this.handleNestAndTrump();
            }
            
            async handleNestAndTrump() {
                await this.revealNest();
                this.highBidder.hand.push(...this.nest);
                
                let trump;
                if (this.highBidder.isHuman) {
                    this.highBidder.sortHand(null, this.handSortOrder);
                    this.renderPlayerHand(this.highBidder.id, false, true);
                    await this.getHumanBury();
                    trump = await this.getHumanTrump();
                } else {
                    if (this.difficulty === 'hard') {
                        const { trumpSuit, buriedCards } = this.highBidder.chooseAdvancedTrumpAndBury();
                        this.widow = buriedCards;
                        trump = trumpSuit;
                    } else {
                        const counts = SUITS.reduce((acc, suit) => { acc[suit] = this.highBidder.hand.filter(c => c.suit === suit).length; return acc; }, {});
                        trump = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                        this.setTrump(trump); // Set trump early for basic AI to bury correctly
                        const toBury = this.highBidder.chooseCardsToBury(this.difficulty);
                        this.widow = toBury;
                        this.highBidder.hand = this.highBidder.hand.filter(c => !toBury.includes(c));
                    }
                    this.showMessage(`${this.dom.infos[this.highBidder.id].textContent} creates the widow.`, 1500);
                }
                
                this.renderPlayerHand(this.highBidder.id); 
                this.renderWidowOnTable(); 
                await this.sleep(1500);
                this.setTrump(trump);
                await this.sleep(1500);
                this.startTrickPlay();
            }
            
            async startTrickPlay() {
                this.trickLeaderIndex = this.players.indexOf(this.highBidder);
                this.team1Tricks = []; this.team2Tricks = [];
                this.trickHistory = [];
                for (let i = 0; i < 10; i++) { await this.playTrick(); }
                this.endHand();
            }
            
            async playTrick() {
                this.currentTrick = []; this.dom.trickArea.innerHTML = '';
                for (let i = 0; i < 4; i++) {
                    const pIndex = (this.trickLeaderIndex + i) % 4; const player = this.players[pIndex];
                    this.dom.infos.forEach(info => info.classList.remove('font-bold', 'text-yellow-300'));
                    this.dom.infos[pIndex].classList.add('font-bold', 'text-yellow-300');
                    let playedCard;
                    if (player.isHuman) { 
                        playedCard = await this.getHumanCardPlay(); 
                    } else { 
                        await this.sleep(1000);
                        if (this.difficulty === 'hard') {
                            playedCard = player.playAdvancedCard(this.currentTrick, this.trumpSuit, this.trickHistory);
                        } else {
                             playedCard = player.playCard(this.currentTrick, this.trumpSuit, this.difficulty);
                        }
                    }
                    player.hand = player.hand.filter(c => c.id !== playedCard.id); this.renderPlayerHand(pIndex);
                    this.currentTrick.push({ card: playedCard, player: player }); this.renderTrick(); await this.sleep(500);
                }
                const winnerInfo = this.determineTrickWinner(this.currentTrick);
                this.trickLeaderIndex = winnerInfo.player.id;
                
                if (this.currentTrick.some(p => p.card.rank === 'Rook')) {
                    this.currentHandData.rookWinner = this.dom.infos[winnerInfo.player.id].textContent;
                    this.updateLiveSummary('rook');
                }
                
                this.lastTrick = [...this.currentTrick];
                this.trickHistory.push(this.lastTrick);
                this.dom.seeLastTrickBtn.disabled = false;

                this.showMessage(`${this.dom.infos[winnerInfo.player.id].textContent} wins the trick!`, 1500);
                const captured = this.currentTrick.map(p => p.card);
                if (winnerInfo.player.id === 0 || winnerInfo.player.id === 2) { this.team1Tricks.push(...captured); } else { this.team2Tricks.push(...captured); }
                await this.sleep(2000);
            }
            
            determineTrickWinner(trick) {
                if (!trick || trick.length === 0) return null;
                let winningPlay = trick[0];
                
                const rookPlay = trick.find(p => p.card.rank === 'Rook');
                if (rookPlay) return { player: rookPlay.player, card: rookPlay.card };

                const leadSuit = winningPlay.card.rank === 'Rook' ? this.trumpSuit : winningPlay.card.suit;
                
                for (let i = 1; i < trick.length; i++) {
                    const currentPlay = trick[i];
                    const winningCard = winningPlay.card;
                    const currentCard = currentPlay.card;

                    if (winningCard.suit === this.trumpSuit) {
                        if (currentCard.suit === this.trumpSuit && currentCard.power > winningCard.power) {
                            winningPlay = currentPlay;
                        }
                    } else {
                        if (currentCard.suit === this.trumpSuit) {
                            winningPlay = currentPlay;
                        } else if (currentCard.suit === leadSuit && currentCard.power > winningCard.power) {
                            winningPlay = currentPlay;
                        }
                    }
                }
                return { player: winningPlay.player, card: winningPlay.card };
            }
            
            endHand() {
                this.dom.trickArea.innerHTML = '';
                if (this.trickLeaderIndex === 0 || this.trickLeaderIndex === 2) { this.team1Tricks.push(...this.widow); } else { this.team2Tricks.push(...this.widow); }
                const t1s = this.team1Tricks.reduce((s, c) => s + c.value, 0), t2s = this.team2Tricks.reduce((s, c) => s + c.value, 0);
                const bidTeamId = this.players.indexOf(this.highBidder), bidTeam = (bidTeamId === 0 || bidTeamId === 2) ? 1 : 2;
                
                this.currentHandData.team1Score = 0; this.currentHandData.team2Score = 0;

                if (bidTeam === 1) {
                    if (this.isShootingMoon) { if (t1s === 180) { this.scores.team1 = WINNING_SCORE; this.currentHandData.team1Score = "WIN"; } else { this.scores.team1 -= 180; this.currentHandData.team1Score = -180; } }
                    else { if (t1s >= this.highBid) { this.scores.team1 += t1s; this.currentHandData.team1Score = t1s; } else { this.scores.team1 -= this.highBid; this.currentHandData.team1Score = `-${this.highBid}`; } this.scores.team2 += t2s; this.currentHandData.team2Score = t2s; }
                } else {
                    if (this.isShootingMoon) { if (t2s === 180) { this.scores.team2 = WINNING_SCORE; this.currentHandData.team2Score = "WIN"; } else { this.scores.team2 -= 180; this.currentHandData.team2Score = -180; } }
                    else { if (t2s >= this.highBid) { this.scores.team2 += t2s; this.currentHandData.team2Score = t2s; } else { this.scores.team2 -= this.highBid; this.currentHandData.team2Score = `-${this.highBid}`; } this.scores.team1 += t1s; this.currentHandData.team1Score = t1s; }
                }
                
                this.handHistory.push(this.currentHandData);
                this.updateScoreboard();
                this.showRoundSummary();
            }
            
            showRoundSummary() {
                const scoreBody = document.getElementById('score-pad-body');
                const total1 = document.getElementById('total-score-1');
                const total2 = document.getElementById('total-score-2');

                scoreBody.innerHTML = '';

                this.handHistory.forEach(hand => {
                    const row = document.createElement('div');
                    row.className = 'score-pad-row';
                    const score1 = hand.team1Score;
                    const score2 = hand.team2Score;
                    const displayScore1 = (typeof score1 === 'number' && score1 >= 0) ? score1 : `(${score1.toString().replace('-', '')})`;
                    const displayScore2 = (typeof score2 === 'number' && score2 >= 0) ? score2 : `(${score2.toString().replace('-', '')})`;
                    row.innerHTML = `<div>${displayScore1}</div><div>${displayScore2}</div>`;
                    scoreBody.appendChild(row);
                });

                total1.textContent = `Total: ${this.scores.team1}`;
                total2.textContent = `Total: ${this.scores.team2}`;
                
                this.showModal('roundSummary');
            }

            showLastTrick() {
                if (!this.lastTrick || this.lastTrick.length === 0) return;
                const display = document.getElementById('last-trick-display');
                display.innerHTML = '';
                this.lastTrick.forEach(play => {
                    const playContainer = document.createElement('div');
                    playContainer.className = 'flex flex-col items-center gap-2';
                    
                    const cardEl = this.createCardElement(play.card, true);
                    cardEl.style.margin = '0';

                    const playerNameEl = document.createElement('p');
                    playerNameEl.className = 'text-sm font-semibold';
                    let playerName = this.dom.infos[play.player.id].textContent;
                    if (playerName.includes(' (D)')) {
                        playerName = playerName.split(' (D)')[0];
                    }
                    playerNameEl.textContent = playerName;

                    playContainer.appendChild(cardEl);
                    playContainer.appendChild(playerNameEl);
                    display.appendChild(playContainer);
                });
                this.showModal('lastTrick');
            }

            getHumanBid(hasShootOpt) {
                return new Promise(resolve => {
                    const input = document.getElementById('bid-input'), display = document.getElementById('current-bid-display'), submitBtn = document.getElementById('submit-bid-button'), passBtn = document.getElementById('pass-button'), shootBtn = document.getElementById('shoot-moon-button');
                    const nextBid = this.highBid + 5;
                    const highBidderName = this.highBidder ? ` (${this.dom.infos[this.highBidder.id].textContent})` : '';
                    display.innerHTML = `${this.highBid}<span class="text-sm text-gray-400 ml-2">${highBidderName}</span>`;
                    input.value = nextBid; input.min = nextBid;
                    shootBtn.style.display = hasShootOpt ? 'inline-block' : 'none';
                    const cleanup = () => { submitBtn.onclick = null; passBtn.onclick = null; shootBtn.onclick = null; this.hideModal('bidding'); };
                    submitBtn.onclick = () => { const val = Number(input.value); if (val >= nextBid && val <= 180 && val % 5 === 0) { cleanup(); resolve(val); } else { this.showMessage("Invalid bid amount.", 1500); } };
                    passBtn.onclick = () => { cleanup(); resolve('pass'); };
                    shootBtn.onclick = () => { cleanup(); resolve('shoot'); };
                    this.showModal('bidding');
                });
            }
            
            getHumanBury() {
                return new Promise(resolve => {
                    const countEl = document.getElementById('bury-count'), confirmBtn = document.getElementById('bury-confirm-button');
                    this.showModal('bury');
                    let selected = [];
                    const handEl = this.dom.hands[HUMAN_PLAYER_ID];
                    handEl.querySelectorAll('.card').forEach(el => {
                        el.classList.add('cursor-pointer');
                        el.onclick = () => {
                            const id = el.dataset.id;
                            if (selected.includes(id)) { selected = selected.filter(i => i !== id); el.classList.remove('selected-for-bury'); }
                            else if (selected.length < 5) { selected.push(id); el.classList.add('selected-for-bury'); }
                            countEl.textContent = selected.length; confirmBtn.disabled = selected.length !== 5;
                        };
                    });
                    confirmBtn.onclick = () => {
                        const human = this.players[HUMAN_PLAYER_ID];
                        this.widow = human.hand.filter(c => selected.includes(c.id));
                        human.hand = human.hand.filter(c => !selected.includes(c.id));
                        handEl.querySelectorAll('.card').forEach(el => { el.classList.remove('selected-for-bury'); el.onclick = null; });
                        this.hideModal('bury');
                        resolve();
                    };
                });
            }

            getHumanTrump() { 
                return new Promise(resolve => { 
                    this.showModal('trump');
                    document.getElementById('trump-options').onclick = e => { 
                        if (e.target.tagName === 'BUTTON') { 
                            this.hideModal('trump');
                            resolve(e.target.dataset.suit); 
                        } 
                    }; 
                }); 
            }
            
            getHumanCardPlay() {
                return new Promise(resolve => {
                    const human = this.players[HUMAN_PLAYER_ID];
                    const playableCards = human.getPlayableCards(this.currentTrick.map(p => p.card), this.trumpSuit);
                    const playableIds = playableCards.map(c => c.id);
                    const handEl = this.dom.hands[HUMAN_PLAYER_ID];

                    const cleanup = () => {
                        handEl.querySelectorAll('.card').forEach(e => {
                            e.classList.remove('playable');
                            e.onclick = null;
                        });
                    };

                    handEl.querySelectorAll('.card').forEach(el => {
                        if (playableIds.includes(el.dataset.id)) {
                            el.classList.add('playable');
                            el.onclick = () => {
                                const cardId = el.dataset.id;
                                cleanup();
                                resolve(human.hand.find(c => c.id === cardId));
                            };
                        }
                    });
                });
            }

            renderAllHands(isDealing = false) { this.players.forEach((p, i) => this.renderPlayerHand(i, isDealing)); }
            renderPlayerHand(id, isDealing = false, isBurying = false) {
                const handEl = this.dom.hands[id]; handEl.innerHTML = '';
                const hand = this.players[id].hand;
                
                handEl.classList.toggle('bury-selection', isBurying);

                const margin = (id === HUMAN_PLAYER_ID || id === 2) ? -48 : -25;
                
                hand.forEach((card, i) => {
                    const cardEl = this.createCardElement(card, this.players[id].isHuman);
                    cardEl.style.margin = `0 ${margin}px`;
                    const zIndex = (id === HUMAN_PLAYER_ID || id === 2) ? i : hand.length - i;
                    cardEl.style.zIndex = zIndex;
                    if (isDealing) {
                        cardEl.style.transform = `translateY(100vh)`;
                        setTimeout(() => { handEl.appendChild(cardEl); cardEl.style.transform = 'none'; }, i * 50 + Math.random() * 50);
                    } else { handEl.appendChild(cardEl); }
                });
            }
            createCardElement(card, isFaceUp) {
                const el = document.createElement('div'); el.className = 'card'; el.dataset.id = card.id; el.dataset.suit = card.suit;
                const rank = card.rank === 'Rook' ? '🐦' : card.rank;
                el.innerHTML = `
                    <div class="card-face"><span class="rank">${rank}</span><span class="suit-icon">${rank}</span></div>
                    <div class="card-back-face"><span>🐦‍⬛</span></div>`;
                if (!isFaceUp) el.classList.add('is-flipped');
                return el;
            }
            renderTrick() {
                this.dom.trickArea.innerHTML = '';
                this.currentTrick.forEach((play) => {
                    const cardEl = this.createCardElement(play.card, true);
                    const positions = [
                        { top: '75%', left: '50%', transform: 'translate(-50%, -50%)' }, // P0
                        { top: '50%', left: '25%', transform: 'translate(-50%, -50%)' }, // P1
                        { top: '25%', left: '50%', transform: 'translate(-50%, -50%)' }, // P2
                        { top: '50%', left: '75%', transform: 'translate(-50%, -50%)' }  // P3
                    ];
                    const p = positions[play.player.id];
                    cardEl.style.top = p.top; cardEl.style.left = p.left; cardEl.style.transform = p.transform;
                    this.dom.trickArea.appendChild(cardEl);
                });
            }
            renderNest() {
                this.dom.nestDisplay.innerHTML = '';
                this.nest.forEach((card, i) => {
                    const isTopCard = i === this.nest.length - 1;
                    const cardEl = this.createCardElement(card, isTopCard);
                    cardEl.style.transform = `translate(-50%, -50%) rotate(${i*5-10}deg)`;
                    this.dom.nestDisplay.appendChild(cardEl);
                });
            }
            renderWidowOnTable() {
                this.dom.widowOnTable.innerHTML = '';
                const bidderId = this.highBidder.id;
                const positions = [
                    { bottom: '22%', right: '20%' }, // P0 (Human)
                    { top: '65%', left: '20%' },     // P1 (Left)
                    { top: '22%', left: '20%' },     // P2 (Partner)
                    { top: '22%', right: '20%' }     // P3 (Right)
                ];
                const pos = positions[bidderId];
                this.dom.widowOnTable.style.top = pos.top || 'auto';
                this.dom.widowOnTable.style.bottom = pos.bottom || 'auto';
                this.dom.widowOnTable.style.left = pos.left || 'auto';
                this.dom.widowOnTable.style.right = pos.right || 'auto';

                for (let i = 0; i < 5; i++) {
                    const cardEl = this.createCardElement(new Card('Special', 'Rook'), false);
                    cardEl.style.transform = `translateX(${i * 3}px) translateY(${i * -2}px)`;
                    this.dom.widowOnTable.appendChild(cardEl);
                }
            }
            async revealNest() {
                this.showMessage("Revealing the Nest...", 1000);
                await this.sleep(1000);
                this.dom.nestDisplay.innerHTML = '';
                this.nest.forEach((card, i) => {
                    const cardEl = this.createCardElement(card, false);
                    cardEl.style.left = `${20 + i * 15}%`;
                    cardEl.style.top = '50%';
                    cardEl.style.transform = 'translate(-50%, -50%)';
                    this.dom.nestDisplay.appendChild(cardEl);
                });
                
                const nestCards = Array.from(this.dom.nestDisplay.children);
                for(let i = 0; i < nestCards.length; i++) {
                    await this.sleep(200);
                    nestCards[i].classList.remove('is-flipped');
                }
                await this.sleep(2000);
                this.dom.nestDisplay.innerHTML = '';
            }
            setTrump(suit) {
                this.trumpSuit = suit; this.players.forEach(p => p.sortHand(this.trumpSuit, this.handSortOrder)); this.renderAllHands();
                this.currentHandData.trumpSuit = suit;
                this.updateLiveSummary('trump');
                this.showMessage(`Trump is ${suit}!`, 2000);
                this.dom.trumpIndicator.classList.remove('hidden');
                this.dom.trumpIndicator.textContent = suit[0];
                this.dom.trumpIndicator.style.backgroundColor = `var(--${suit.toLowerCase()}-suit)`;
                this.dom.trumpIndicator.style.color = (suit === 'Yellow' || suit === 'Green') ? 'black' : 'white';
            }
            updateScoreboard() {
                this.dom.gameSummaryBox.innerHTML = `
                    <div class="total-scores">
                        <div>Team 1: ${this.scores.team1}</div>
                        <div>Team 2: ${this.scores.team2}</div>
                    </div>
                    <table class="current-hand-info w-full text-left">
                        <tbody>
                            <tr><td>Dealer:</td><td><span id="live-dealer">...</span></td></tr>
                            <tr><td>High Bid:</td><td><span id="live-bid">...</span></td></tr>
                            <tr><td>Trump:</td><td><span id="live-trump">...</span></td></tr>
                            <tr><td>Rook:</td><td><span id="live-rook">...</span></td></tr>
                        </tbody>
                    </table>`;
            }
            showMessage(msg, duration) { this.dom.statusMessage.textContent = msg; this.dom.statusMessage.classList.remove('hidden'); setTimeout(() => this.dom.statusMessage.classList.add('hidden'), duration); }
            updateLiveSummary(field) {
                if (!this.dom.gameSummaryBox.querySelector('#live-dealer')) this.updateScoreboard();
                if (!field || field === 'dealer') { document.getElementById('live-dealer').textContent = this.currentHandData.dealer != null ? `P${this.currentHandData.dealer + 1}` : '...'; }
                if (!field || field === 'bid') { document.getElementById('live-bid').textContent = this.currentHandData.bidAmount ? `${this.currentHandData.bidAmount} (${this.currentHandData.highBidder})` : '...'; }
                if (!field || field === 'trump') { document.getElementById('live-trump').textContent = this.currentHandData.trumpSuit || '...'; }
                if (!field || field === 'rook') { document.getElementById('live-rook').textContent = this.currentHandData.rookWinner || '...'; }
            }
            sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
        }

        const game = new Game();
    </script>
</body>
</html>
